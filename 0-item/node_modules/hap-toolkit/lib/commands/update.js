"use strict";var _path=_interopRequireDefault(require("path")),_fsExtra=_interopRequireDefault(require("fs-extra")),_chalk=_interopRequireDefault(require("chalk")),_semver=_interopRequireDefault(require("semver")),_enquirer=require("enquirer"),_utils=require("./utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var curDir=process.cwd(),toolkitDir=_path.default.join(__dirname,"../.."),packageInfo=require("../../package.json");function checkVersion(){var e,a={cur:"",toolkit:"",res:0},t=_path.default.join(curDir,"package.json");return _fsExtra.default.existsSync(t)&&(e=JSON.parse(_fsExtra.default.readFileSync(t).toString()),a.cur=e.subversion&&e.subversion.toolkit||""),""===a.cur&&(a.res=1),a.toolkit=packageInfo.version,""===a.toolkit?(console.log("### App Toolkit ### 当前toolkit的文件错误, 无法升级, 请重新安装后再升级"),a.res=-1):1!==a.res&&(a.res=_semver.default.gt(a.toolkit,a.cur)?1:0),a}function mergeProps(e,a){if(e)for(var t in a)e[t]||/babel-|^webpack$|^koa/.test(t)||(e[t]=a[t])}var dependencies=["babel-cli","babel-core","babel-eslint","babel-loader","babel-plugin-syntax-jsx","cross-env","css-what","koa","koa-body","koa-router","koa-send","koa-static","socket.io","style-loader","webpack"];function cleanupDependencies(t,e){if(e)return t.devDependencies={},Promise.resolve(t);if(!t.devDependencies)return Promise.resolve(t);var o=dependencies.filter(function(e){return t.devDependencies[e]});return o.length?new Promise(function(a){new _enquirer.Confirm({message:"检测到已包含在 hap-toolkit 中的模块依赖，现在将其移除",initial:"y"}).run().then(function(e){e&&new _enquirer.MultiSelect({name:"packages",message:"将移除以下选中的模块",initial:o,choices:o}).run().then(function(e){e.forEach(function(e){t.devDependencies[e]=void 0}),a(t)})})}):Promise.resolve(t)}function upgradePackage(e){console.log(_chalk.default.green("升级 package.json"));var o=_path.default.join(curDir,"package.json"),r=require(o),n=require("../../templates/app/demo/package.json");e&&(n.devDependencies={}),n.devDependencies["hap-toolkit"]=packageInfo.version,n.subversion.toolkit=packageInfo.version,cleanupDependencies(r,e).then(function(e){for(var a in n){var t=n[a];"string"==typeof t&&r[a]?n[a]=e[a]:mergeProps(t,e[a])}_fsExtra.default.writeFileSync(o,JSON.stringify(n,null,2))})}function copyFiles(o,r){var e=[];(0,_utils.traverseDirSync)(r,e),e.forEach(function(e){var a=_path.default.relative(r,e),t=_path.default.join(o,a);console.log(_chalk.default.green("file ".concat((0,_utils.relatCwd)(t)," copied."))),_fsExtra.default.copySync(e,t)})}function upgradeSign(){console.log(_chalk.default.green("升级 签名文件"));var e=_path.default.join(curDir,"sign/debug");(0,_utils.clearDirSync)(e),(0,_utils.mkdirsSync)(e),copyFiles(e,_path.default.join(toolkitDir,"templates/app/demo/sign/debug"))}function upgradeEslint(){var e=".eslintrc.json",a=_path.default.join(toolkitDir,"templates/app/demo",e),t=_path.default.join(curDir,e);_fsExtra.default.copySync(a,t)}function upgradeBabelConfig(){var e="babel.config.js",a=".babelrc",t=_path.default.join(toolkitDir,"templates/app/demo",e),o=_path.default.join(curDir,a),r=_path.default.join(curDir,e),n=(0,_utils.formatDate)("yyyyMMdd_hhmmss",new Date);if(console.log(_chalk.default.green("项目升级到 babel7 ，默认配置使用 babel.config.js")),_fsExtra.default.existsSync(o)){var l=_path.default.join(curDir,a+".old."+n);_fsExtra.default.copySync(o,l),_fsExtra.default.removeSync(o),console.log(_chalk.default.yellow("### App Toolkit ### ".concat(a," 的备份文件保存为: ").concat((0,_utils.relatCwd)(l))))}if(_fsExtra.default.existsSync(r)){var i=_path.default.join(curDir,_path.default.basename(e,".js")+".old."+n+".js");_fsExtra.default.copySync(r,i),console.log(_chalk.default.yellow("### App Toolkit ### 更新的 ".concat(e," 的备份文件保存为: ").concat((0,_utils.relatCwd)(i))))}_fsExtra.default.existsSync(t)&&(_fsExtra.default.copySync(t,r),console.log(_chalk.default.yellow("### App Toolkit ### 更新的 ".concat(e," 成功！"))))}function savePackage(){var e="package.json",a=_path.default.join(curDir,e),t=(0,_utils.formatDate)("yyyyMMdd_hhmmss",new Date),o=_path.default.join(curDir,_path.default.basename(e,".json")+".old."+t+".json");_fsExtra.default.copySync(a,o),console.log(_chalk.default.yellow("### App Toolkit ### 更新的".concat(e,"的备份文件保存为: ").concat((0,_utils.relatCwd)(o))))}function updateProject(e){var a=checkVersion();if(e)console.log(_chalk.default.yellow("强制升级工程( ".concat(a.cur," ----\x3e ").concat(a.toolkit," )(可能会出现兼容性问题)"))),savePackage(),upgradePackage(e);else{if(a.res<0||0===a.res&&!e)return void(0===a.res&&console.log("### App Toolkit ### 版本已经是最新版本"));console.log(_chalk.default.green("升级工程( ".concat(a.cur," ----\x3e ").concat(a.toolkit," )"))),upgradePackage()}upgradeSign(),upgradeEslint(),upgradeBabelConfig(),console.log(_chalk.default.green("升级完毕, 请运行npm install更新依赖包"))}module.exports=updateProject;
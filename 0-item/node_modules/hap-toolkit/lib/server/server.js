"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.start=start;var _http=_interopRequireDefault(require("http")),_fs=_interopRequireDefault(require("fs")),_koa=_interopRequireDefault(require("koa")),_utils=require("./lib/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function asyncGeneratorStep(e,r,t,o,n,s,c){try{var a=e[s](c),i=a.value}catch(e){return void t(e)}a.done?r(i):Promise.resolve(i).then(o,n)}function _asyncToGenerator(a){return function(){var e=this,c=arguments;return new Promise(function(r,t){var o=a.apply(e,c);function n(e){asyncGeneratorStep(o,r,t,n,s,"next",e)}function s(e){asyncGeneratorStep(o,r,t,n,s,"throw",e)}n(void 0)})}}function initServer(e,r){return _initServer.apply(this,arguments)}function _initServer(){return(_initServer=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var o,n,s,c,a,i,u,l,p,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(e.prev=0,(o=new _koa.default).context.conf=r,r.options.clearRecords&&(n=r.defaults.pathClientLog,_fs.default.existsSync(n)?(_fs.default.unlinkSync(n),_utils.colorconsole.info("### App Server ### 清空调试设备记录")):_utils.colorconsole.info("### App Server ### 没有需要清空的调试设备记录")),s=0,c=t.moduleList.length;s<c;s++)a=t.moduleList[s],o.use(a.hash.applyRouter(o).routes());i=_http.default.Server(o.callback()),o.server=i,u=0,l=t.moduleList.length;case 9:if(!(u<l)){e.next=17;break}if("function"==typeof(p=t.moduleList[u]).hash.beforeStart)return e.next=14,p.hash.beforeStart(i,o);e.next=14;break;case 14:u++,e.next=9;break;case 17:f=r.defaults.serverPort,i.listen(f,function(){var e="http://localhost:".concat(f),r=(0,_utils.getIPv4IPAddress)();if(r){var t="http://".concat(r,":").concat(f);_utils.colorconsole.info("### App Server ### 服务器地址: ".concat(e,", ").concat(t)),_utils.colorconsole.info("### App Server ### 请确保手机与App Server处于相同网段"),(0,_utils.outputQRCodeOnTerminal)(t)}else _utils.colorconsole.warn("### App Server ### 本机IP地址为空，无法通过WIFI调试")}),o.on("error",function(e,r){_utils.colorconsole.error("### App Server ### 服务器错误: ".concat(e.message));var t="出错了!HTTP error code: ".concat(e.status,", 出错信息: ").concat(e.message);r&&(r.body=t)}),i.on("error",function(e){_utils.colorconsole.error("### App Server ### 服务器错误: ".concat(e.message)),"EADDRINUSE"===e.code&&_utils.colorconsole.error("### App Server ### 服务器错误:端口 ".concat(f," 被占用, 请检查"))}),process.on("SIGINT",function(){_utils.colorconsole.info("### App Server ### SIGINT信号"),_utils.colorconsole.info("### App Server ### 退出server进程 pid: ".concat(process.pid)),process.exit()}),process.on("uncaughtException",function(e){_utils.colorconsole.error("### App Server ### 未定义的异常, 出错信息: ".concat(e.message))}),process.on("message",function(e){e&&e.source&&(o.source=e.source)}),e.next=29;break;case 26:e.prev=26,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 服务器启动失败: ".concat(e.t0.message));case 29:case"end":return e.stop()}},e,this,[[0,26]])}))).apply(this,arguments)}function start(e,r){return _start.apply(this,arguments)}function _start(){return(_start=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:initServer(r,t);case 1:case"end":return e.stop()}},e,this)}))).apply(this,arguments)}
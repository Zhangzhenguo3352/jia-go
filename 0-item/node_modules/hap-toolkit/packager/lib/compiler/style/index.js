"use strict";var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_css=_interopRequireDefault(require("css")),_cssWhat=_interopRequireDefault(require("css-what")),_validator=require("./validator"),_compress=require("./compress"),_config=require("../../common/config"),_utils=require("../../common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function processImport(e,o,i,n){var l=e,t=e.match(/@import\s+((?:['"]([^()]+?)['"])|(?:(?:url\(([^()]+?)\))))\s*;/g);return t&&0<t.length&&(o?t.forEach(function(e){var t=e.match(/(?:['"]([^()]+?)['"])|(?:(?:url\(([^()]+?)\)))/);if(1<t.length){var a=_path.default.resolve(o,t[1]||t[2]),s=_fs.default.readFileSync(a);if(s){var r=_path.default.dirname(a);l=l.replace(e,"\n"+processImport(s.toString(),r,i,n)+"\n"),n.push(a)}else i.push({line:1,column:1,reason:"ERROR: 找不到文件 `"+e+"` , 导入失败"})}}):i.push({line:1,column:1,reason:"ERROR: 找不到资源路径, 无法处理@import"})),l}function parse(e,t){var a,u={},c=[],s=e.code||"",p=e.filePath,r=[];s=processImport(s,_path.default.dirname(p),c,r);var o=_css.default.parse(s,{silent:!0});o.stylesheet.parsingErrors&&o.stylesheet.parsingErrors.length&&(a=o.stylesheet.parsingErrors).forEach(function(e){c.push({line:e.line,column:e.column,reason:e.toString()})}),o&&"stylesheet"===o.type&&o.stylesheet&&o.stylesheet.rules&&o.stylesheet.rules.length&&o.stylesheet.rules.forEach(function(a){var e=a.type,o={};if("rule"===e){if(a.declarations&&a.declarations.length){a.declarations.forEach(function(e){if("declaration"===e.type){var t=e.property,a=e.value,s=(0,_utils.hyphenedToCamelCase)(t),r=(0,_validator.validate)(s,a,{filePath:p});r.value.forEach(function(e){(0,_utils.isValidValue)(e.v)&&(o[e.n]=e.v)}),r.log&&c.push({line:e.position.start.line,column:e.position.start.column,reason:r.log.reason})}});var s=/^[.#]?[A-Za-z0-9_\-:]+$/,r=/^([.#]?[A-Za-z0-9_-]+(\s+|\s*>\s*))+([.#]?[A-Za-z0-9_\-:]+)$/;a.selectors.forEach(function(e){var t={key:e,val:o};if(e.match(s)||e.match(r)){if(!processPseudoClass(t,c,a))return;if(u[t.key]&&e===t.key&&!(0,_utils.equals)(u[t.key],t.val,cssCompare)&&c.push({line:a.position.start.line,column:a.position.start.column,reason:"WARN: 选择器 `"+t.key+"` 已经存在，后者合并前者"}),!_config.options.optimizeDescMeta&&e.match(r))try{t.val=Object.assign({},t.val),t.val._meta={},t.val._meta.ruleDef=(0,_compress.compressDescSelector)((0,_cssWhat.default)(t.key))}catch(e){return void c.push({line:a.position.start.line,column:a.position.start.column,reason:"ERROR: 选择器 `"+t.key+"` 不支持"})}u[t.key]=(0,_utils.extend)({},u[t.key]||{},t.val)}else c.push({line:a.position.start.line,column:a.position.start.column,reason:"ERROR: 选择器 `"+e+"` 非法"})})}}else if("font-face"===e){if(a.declarations&&a.declarations.length){var i={};a.declarations.forEach(function(e){if("declaration"===e.type){var t=(0,_utils.hyphenedToCamelCase)(e.property),a=e.value;if("fontFamily"===t)i.fontName=a.replace(/['"]+/g,"");else if("src"===t){var s=(0,_validator.validate)("fontSrc",a,{filePath:p});s.log&&c.push({line:e.position.start.line,column:e.position.start.column,reason:s.log.reason}),i.fontSrc=s.value}}}),u["@FONT-FACE"]||(u["@FONT-FACE"]={}),u["@FONT-FACE"][i.fontName]=i}}else if("keyframes"===e&&a.keyframes&&a.keyframes.length){var n=a.name,l=[];a.keyframes.forEach(function(e){var o,t;"keyframe"===e.type&&(e.declarations&&e.declarations.length&&(o={},e.declarations.forEach(function(e){if("declaration"===e.type){var t=e.property,a=e.value,s=(0,_utils.hyphenedToCamelCase)(t),r=(0,_validator.validate)(s,a);r.value.forEach(function(e){(0,_utils.isValidValue)(e.v)&&(o[e.n]=e.v)}),r.log&&c.push({line:e.position.start.line,column:e.position.start.column,reason:r.log.reason})}}),(0,_utils.isEmptyObject)(o)?c.push({line:a.position.start.line,column:a.position.start.column,reason:"ERROR: 动画 `"+n+"` 的关键帧 `"+JSON.stringify(e.values)+"` 没有有效的属性"}):e.values.forEach(function(e){t="from"===e?0:"to"===e?100:parseFloat(e.replace("%","")),o.time=t,l.push(o)})))}),l.sort(function(e,t){return e.time-t.time}),u["@KEYFRAMES"]||(u["@KEYFRAMES"]={}),u["@KEYFRAMES"][n]=l}}),_config.options.optimizeCssAttr&&(0,_compress.compressCssAttr)(u),t(a,{jsonStyle:u,depList:r,log:c})}function processPseudoClass(t,e,a){var s=t.key.indexOf(":");if(-1<s){var r=t.key.slice(s);if(!(0,_validator.validatePseudoClass)(r))return e.push({line:a.position.start.line,column:a.position.start.column,reason:"ERROR: 不支持伪类选择器`"+r+"`"}),!1;t.key=t.key.slice(0,s);var o={};Object.keys(t.val).forEach(function(e){o[e+r]=t.val[e]}),t.val=o}return!0}function cssCompare(e,t,a){if("_meta"===a)return!0}module.exports={parse:parse,validateDelaration:_validator.validate};
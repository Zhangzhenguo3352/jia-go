"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _parse=_interopRequireDefault(require("parse5")),_parser=_interopRequireDefault(require("parse5/lib/parser")),_tokenizer=_interopRequireDefault(require("parse5/lib/tokenizer")),_validator=_interopRequireDefault(require("./validator")),_compress=require("./compress"),_config=require("../../common/config"),_utils=require("../../common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function calcSubTextNodesNum(e,t){var a=0;if(_validator.default.isSupportSpan(e)){var r=_validator.default.getTagChildren(e);t.forEach(function(e){("#text"===e.nodeName&&e.value.trim()||-1<r.indexOf(e.nodeName))&&++a})}return a}function traverse(s,u,o,i,c){_validator.default.checkTagName(s,u,c),(s.attrs||[]).forEach(function(e){var t=e.name,a=t.match(/^:+/);a&&(t=t.slice(a.length));var r=e.value,l={line:1,column:1};switch(s.__location&&(l={line:s.__location.line,column:s.__location.col}),t){case"id":_validator.default.checkId(r,u),_validator.default.checkAttr(t,r,u,s.tagName,l);break;case"class":_validator.default.checkClass(r,u);break;case"style":_validator.default.checkStyle(r,u,l,c);break;case"if":s._isroot||_validator.default.checkIf(r,u,!1,l,i);break;case"else":s._isroot||o&&o.__cond__&&_validator.default.checkElse(o.__cond__,u,l,i);break;case"elif":s._isroot||o&&o.__cond__&&(s.__cond__=_validator.default.checkElif(r,o.__cond__,u,l,i));break;case"for":s._isroot||_validator.default.checkFor(r,u,l);break;case"tree":_validator.default.checkBuild("tree",u);break;default:t.match(/^(on|@)/)?_validator.default.checkEvent(t,r,u):_validator.default.checkAttr(t,r,u,s.tagName,l,c)}});var _=u.result,d=s.childNodes;if(d&&d.length){var f,p=[],m=calcSubTextNodesNum(_.type,d);d.forEach(function(e,t){if(0<t){var a=d[t-1];a.nodeName.match(/^#/)||(f=a).__cond__||f.attrs&&f.attrs.forEach(function(e){"if"!==e.name&&"elif"!==e.name||(f.__cond__=e.value)})}var r={};if(e.nodeName.match(/^#/)){if("#text"===e.nodeName&&e.value.trim()){var l=_validator.default.isSupportSpan(s.tagName)&&2<=m,o=c.importNames&&-1<c.importNames.indexOf(s.tagName);if((l||o)&&(r.type="span",u.result=r,_.children=_.children||[],_.children.push(r),_validator.default.checkAttr("value",e.value,u)),"option"===s.tagName){var i=u.result;return(u.result=_).attr.hasOwnProperty("value")||_validator.default.checkAttr("value",e.value,u),_validator.default.checkAttr("content",e.value,u),void(u.result=i)}if(_validator.default.isSupportSpan(s.tagName)&&1===m||_validator.default.isTextContentAomtic(s.tagName)){var n=u.result;u.result=_,_validator.default.checkAttr("value",e.value,u),u.result=n}}}else u.result=r,_.children=_.children||[],_.children.push(r),traverse(e,u,f,p,c)}),_.children&&0===_.children.length&&(_.children=void 0)}u.result=_}function initParser(e,t){var i=new _parser.default(t),l=i._appendElement,o=i._insertElement;function a(e){if(e.tagName){var t=e.tagName.toLowerCase(),a=e.selfClosing,r=_validator.default.isSupportedSelfClosing(t),l=_validator.default.isEmptyElement(t);if(i.__m.tagName&&!i.__m.selfClosing&&!l){var o=String(e.location.line)+String(e.location.col);(!r||o!==i.__m.pos&&e.type===_tokenizer.default.START_TAG_TOKEN)&&(_utils.colorconsole.warn(t+"标签要闭合，请遵循XML规范"),i.__m={})}r&&(e.type!==_tokenizer.default.START_TAG_TOKEN||a||(i.__m.tagName=t,i.__m.selfClosing=!1,i.__m.pos=String(e.location.line)+String(e.location.col)),e.type===_tokenizer.default.END_TAG_TOKEN&&t===i.__m.tagName&&(i.__m.selfClosing=!0))}}return i._insertElement=function(e){var t=(e.tagName||"").toLowerCase(),a=e.selfClosing,r=_validator.default.isSupportedSelfClosing(t);a&&!r&&_utils.colorconsole.error(t+"标签，禁止使用自闭合"),r||a&&t?l.apply(this,arguments):o.apply(this,arguments)},i.__m={},i._runParsingLoop=function(e){for(;!this.stopped;){this._setupTokenizerCDATAMode();var t=this.tokenizer.getNextToken();if(a(t),t.type===_tokenizer.default.HIBERNATION_TOKEN)break;if(this.skipNextNewLine&&(this.skipNextNewLine=!1,t.type===_tokenizer.default.WHITESPACE_CHARACTER_TOKEN&&"\n"===t.chars[0])){if(1===t.chars.length)continue;t.chars=t.chars.substr(1)}if(this._processInputToken(t),e&&this.pendingScript)break}},i.parseFragment(e)}function parse(e,t,a){var r=initParser(e,{treeAdapter:_parse.default.treeAdapters.default,locationInfo:!0}),l={result:{},log:[]};if(!r||!r.childNodes)return l.log.push({reason:"ERROR: <template>解析失败",line:1,column:1}),void a(null,{jsonTemplate:l.result,log:l.log});var o=r.childNodes.filter(function(e){return"#"!==e.nodeName.charAt(0)});if(0===o.length)return l.log.push({reason:"ERROR: 没有合法的根节点",line:1,column:1}),void a(null,{jsonTemplate:l.result,log:l.log});if(1<o.length)return l.log.push({reason:"ERROR: <template>节点里只能有一个根节点",line:1,column:1}),void a(null,{jsonTemplate:l.result,log:l.log});var i=o[0];i._isroot=!0,traverse(i,l,null,null,t),_config.options.optimizeTemplateAttr&&(0,_compress.compressTemplateAttr)(l.result),a(null,{jsonTemplate:l.result,log:l.log})}var _default={parse:parse};exports.default=_default;
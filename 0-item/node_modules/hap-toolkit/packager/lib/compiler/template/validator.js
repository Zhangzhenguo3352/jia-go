"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _exp=_interopRequireDefault(require("./exp")),_style=_interopRequireDefault(require("../style")),info=_interopRequireWildcard(require("../../common/info")),_utils=require("../../common/utils");function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)if(Object.prototype.hasOwnProperty.call(e,a)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,a):{};n.get||n.set?Object.defineProperty(t,a,n):t[a]=e[a]}return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var REG_TAG_DATA_ATTR=/^data-\w+/,RESERVED_TAGS=Object.keys(_utils.FRAG_TYPE).map(function(e){return _utils.FRAG_TYPE[e]}),tagCommon={events:["click","focus","blur","longpress","appear","disappear","swipe","touchstart","touchmove","touchend","touchcancel"],attrs:{id:{},style:{},class:{},disabled:{enum:["false","true"]},if:{def:"true"},elif:{def:"true"},else:{},for:{},tid:{},show:{def:"true"}},children:["block","slot"],parents:["block"]},tagNatives={div:{supportCard:!0},a:{supportCard:!0,textContent:!0,children:["span"],attrs:{visited:{enum:["false","true"]},href:{}}},text:{supportCard:!0,textContent:!0,children:["a","span"],attrs:{type:{enum:["text","html"]}}},span:{supportCard:!0,textContent:!0,atomic:!0,excludeRoot:!0,parents:["text","a"],attrs:{extendCommon:!1,id:{},style:{},class:{},for:{},tid:{},if:{def:"true"},elif:{def:"true"},else:{}}},label:{supportCard:!0,textContent:!0,atomic:!0,attrs:{target:{}}},image:{events:["complete","error"],empty:!0,supportCard:!0,selfClosing:!0,alias:["img"],atomic:!0,attrs:{src:{},alt:{}}},slider:{selfClosing:!0,atomic:!0,attrs:{enabled:{enum:["true","false"]},min:{def:0},max:{def:100},step:{def:1},value:{def:0}},events:["change"]},web:{atomic:!0,events:["pagestart","pagefinish","titlereceive","error","message"],attrs:{src:{},trustedurl:{},allowthirdpartycookies:{enum:["false","true"]}}},list:{children:["list-item"],attrs:{scrollpage:{enum:["false","true"]}},events:["scroll","scrollbottom","scrolltop"]},"list-item":{excludeRoot:!0,parents:["list"],attrs:{type:{required:!0}}},block:{excludeRoot:!0,attrs:{extendCommon:!1,for:{},tid:{},if:{def:"true"},elif:{def:"true"},else:{}}},slot:{selfClosing:!0,atomic:!0,excludeRoot:!0,attrs:{extendCommon:!1,content:{}}},input:{supportCard:!0,selfClosing:!0,atomic:!0,empty:!0,attrs:{type:{enum:["text","button","checkbox","radio","email","date","time","number","password"]},enterkeytype:{enum:["default","next","go","done","send","search"]},maxlength:{},checked:{enum:["false","true"]},name:{},value:{},placeholder:{}},events:["change","enterkeyclick","selectionchange"]},button:{supportCard:!0,textContent:!0,atomic:!0},refresh:{attrs:{offset:{def:"132px"},refreshing:{enum:["false","true"]}},events:["refresh"]},swiper:{attrs:{index:{def:0},autoplay:{enum:["false","true"]},interval:{def:3e3},indicator:{enum:["true","false"]},loop:{enum:["true","false"]}},events:["change"]},progress:{supportCard:!0,selfClosing:!0,atomic:!0,attrs:{percent:{def:0},type:{enum:["horizontal","circular"]}}},picker:{supportCard:!0,selfClosing:!0,atomic:!0,attrs:{type:{required:!0,enum:["text","date","time","multi-text"]},start:{def:"1970-1-1"},end:{def:"2100-12-31"},range:{},selected:{},value:{}},events:["change","columnchange","cancel"]},switch:{supportCard:!0,selfClosing:!0,atomic:!0,attrs:{checked:{enum:["false","true"]}},events:["change"]},textarea:{supportCard:!0,atomic:!0,textContent:!0,attrs:{placeholder:{},maxlength:{}},events:["change","selectionchange"]},video:{atomic:!0,attrs:{src:{},muted:{enum:["false","true"]},autoplay:{enum:["false","true"]},controls:{enum:["true","false"]},poster:{}},events:["prepared","start","pause","finish","error","seeking","seeked","timeupdate","fullscreenchange"]},map:{atomic:!0,selfClosing:!0,attrs:{latitude:{},longitude:{},coordtype:{},scale:{def:0},rotate:{def:0},markers:{},showmylocation:{enum:["true","false"]},polylines:{},circles:{},controls:{},groundoverlays:{},includepoints:{}},events:["loaded","regionchange","tap","markertap","callouttap","controltap"]},canvas:{atomic:!0},stack:{supportCard:!0},richtext:{textContent:!0,atomic:!0,attrs:{type:{required:!0,enum:["html"].concat(info.name.richtextType)}}},tabs:{children:["tab-bar","tab-content"],attrs:{index:{def:0}},events:["change"]},"tab-content":{parents:["tabs"],attrs:{scrollable:{enum:["true","false"]}}},"tab-bar":{parents:["tabs"],attrs:{mode:{enum:["fixed","scrollable"]}}},popup:{supportCard:!0,children:["text"],attrs:{target:{required:!0},placement:{enum:["left","top","right","bottom","topLeft","topRight","bottomLeft","bottomRight"],def:"bottom"}},events:["visibilitychange"]},rating:{supportCard:!0,atomic:!0,attrs:{numstars:{def:"5"},rating:{def:"0"},stepsize:{def:"0.5"},indicator:{enum:["false","true"]}},events:["change"]},select:{supportCard:!0,children:["option"],events:["change"],excludeRoot:!0},option:{supportCard:!0,parents:["select"],atomic:!0,textContent:!0,attrs:{selected:{def:!1},value:{}},excludeRoot:!0}},tagReserved=[],tagAliasMap={},tagAttrMap={},tagEnumAttrMap={},tagDefaultAttrMap={},tagRequireAttrMap={},tagAtomics=[],tagTextCotent=[],tagChildrenMap={},tagParentsMap={},tagEventsMap={},tagNotRoot=[];function checkTagName(e,t){var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=t.result,r=t.log,s=e.tagName,l=e.childNodes||[],i=e.__location||{};tagAliasMap[s]&&("img"!==s&&r.push({line:i.line||1,column:i.col||1,reason:"NOTE: 组件名 `"+s+"` 自动转换为 `"+tagAliasMap[s]+"`"}),s=tagAliasMap[s]),n.type=s,0<=RESERVED_TAGS.indexOf(s)&&r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件名 `"+s+"` 非法, 请修改"}),a.uxType===_utils.UX_TYPE.CARD&&tagNatives[s]&&!tagNatives[s].supportCard&&r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 卡片不支持组件名 `"+s+"`, 请修改"}),e._isroot&&0<=tagNotRoot.indexOf(s)&&r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+s+"` 不能作为根组件"}),0<=tagAtomics.indexOf(s)&&(tagTextCotent.indexOf(s)<0?0<l.length&&l.every(function(e){return"#text"===e.nodeName||(r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+s+"` 是原子类型，不应该有子节点"}),!1)}):(1<l.length||l[0]&&"#text"!==l[0].nodeName)&&r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+s+"` 只能有一个文字子节点"})),n.attr=n.attr||{};var o=e.attrs||[],u=[];if(o.forEach(function(e){u.push(e.name.toLowerCase())}),tagDefaultAttrMap[s]&&Object.keys(tagDefaultAttrMap[s]).forEach(function(e){var t=u.indexOf(e);0<=t&&""===o[t].value&&(o[t].value=tagDefaultAttrMap[s][e],r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+s+"` 属性 `"+e+"` 值为空, 默认设置为缺省值 `"+tagDefaultAttrMap[s][e]+"`"}))}),e._isroot){var c=["for","if","elif","else","show"];u.forEach(function(e){0<=c.indexOf(e)&&r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 根节点 `"+s+"` 不能使用属性 `"+e+"`"})})}if(tagRequireAttrMap[s]&&tagRequireAttrMap[s].forEach(function(e){u.indexOf(e)<0&&r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+s+"` 没有定义属性 `"+e+"`"})}),tagEnumAttrMap[s]&&Object.keys(tagEnumAttrMap[s]).forEach(function(e){var t=u.indexOf(e);if(0<=t){var a=o[t].value;if(!_exp.default.isExpr(a)){var n=tagEnumAttrMap[s][e];n.indexOf(a)<0&&(o[t].value=n[0],r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+s+"` 属性 `"+e+"` 的值 `"+a+"`非法, 默认设置为缺省值 `"+n[0]+"`"}))}}}),tagAttrMap[s]&&u.forEach(function(e){if(!e.match(/^(on|@)/)){var t=checkDataAttr(e),a=Object.prototype.hasOwnProperty.call(tagAttrMap[s],e);t||a||r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+s+"` 不支持属性 `"+e+"`，支持的属性有 ["+Object.keys(tagAttrMap[s]).join(", ")+"]"})}}),tagEventsMap[s]){var p=tagEventsMap[s];u.forEach(function(e){if(e.match(/^(on|@)/)){var t=e.replace(/^(on|@)/,"");a.uxType===_utils.UX_TYPE.CARD&&-1<["appear","disappear","swipe"].indexOf(t.toLowerCase())&&r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 卡片组件 `"+s+"` 不支持事件 `"+t+"`"}),p.indexOf(t.toLowerCase())<0&&r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+s+"` 不支持事件 `"+t+"`"})}})}0<l.length&&l.forEach(function(e){if(isReservedTag(s)&&isReservedTag(e.nodeName)){var t=tagParentsMap[e.nodeName],a=tagChildrenMap[s];(t&&t.indexOf(s)<0||a&&a.indexOf(e.nodeName)<0)&&r.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+s+"` 不支持子组件 `"+e.nodeName+"`"})}})}function checkId(e,t){e&&(t.result.id=_exp.default.isExpr(e)?(0,_exp.default)(e):e)}function checkDataAttr(e){return REG_TAG_DATA_ATTR.test(e)}function checkBuild(e,t){e&&(t.result.append="tree"===e?"tree":"single")}function checkClass(className,output){var hasBinding,classList=[];if(className=className.trim(),className){var start=0,end=0,segs=[],matched=className.match(/{{[^]*?}}/g),staticString;if(matched)matched.forEach(function(e){end=className.indexOf(e,start),(staticString=className.slice(start,end)).length&&segs.push(staticString),segs.push(e),start+=staticString.length+e.length});if(segs.push(className.slice(start)),classList=segs.reduce(function(e,t){return _exp.default.isExpr(t)?(hasBinding=!0,e.push((0,_exp.default)(t,!1)),e):e.concat(t.split(/\s+/g).filter(function(e){return e}).map(function(e){return"'".concat(e,"'")}))},[]),classList=classList.filter(function(e){return e.trim()}),hasBinding){var code="(function () {return ["+classList.join(", ")+"]})";output.result.classList=eval(code)}else output.result.classList=classList.map(function(e){return e.slice(1,-1)})}}function checkStyle(e,t,s,l){var i={},o=t.log;if(e){if(_exp.default.singleExpr(e)){var a=_exp.default.removeExprffix(e);return _exp.default.isExpr(a)?o.push({line:s.line||1,column:s.col||1,reason:"ERROR: style 属性不能嵌套多层{{}}"}):i=(0,_exp.default)(e),void(t.result.style=i)}e.split(";").forEach(function(e){var t,a,n,r=e.trim().split(":");2<r.length&&(r[1]=r.slice(1).join(":"),r=r.slice(0,2)),2===r.length&&(t=r[0].trim(),t=(0,_utils.hyphenedToCamelCase)(t),a=r[1].trim(),a=(0,_exp.default)(a),(a=(n=_style.default.validateDelaration(t,a,l)).value).forEach(function(e){((0,_utils.isValidValue)(e.v)||"function"==typeof e.v)&&(i[e.n]=e.v)}),n.log&&o.push({line:s.line||1,column:s.col||1,reason:n.log.reason}))}),t.result.style=i}}function checkIf(e,t,a,n,r){var s=t.log;e?(e=_exp.default.addExprffix(e),a?e="{{"+buildConditionExp(r)+"}}":(0<r.length&&(r.length=0),r.push("".concat(e.substr(2,e.length-4)))),t.result.shown=(0,_exp.default)(e)):a||s.push({line:n.line||1,column:n.col||1,reason:"WARNING: if 属性为空"})}function checkElse(e,t,a,n){checkIf(e,t,!0,a,n),n.length=0}function checkElif(e,t,a,n,r){var s=a.log,l=t;return e?(e=_exp.default.addExprffix(e),t=_exp.default.addExprffix(t),l="{{("+e.substr(2,e.length-4)+") && "+buildConditionExp(r)+"}}",a.result.shown=(0,_exp.default)(l),r.push("".concat(e.substr(2,e.length-4)))):s.push({line:n.line||1,column:n.col||1,reason:"WARNING: Elif 属性为空"}),l}function checkFor(e,t,a){var n=t.log;if(e){var r,s,l,i=(e=_exp.default.removeExprffix(e)).match(/(.*) (?:in) (.*)/);if(i){var o=i[1].match(/\((.*),(.*)\)/);s=o?(r=o[1].trim(),o[2].trim()):i[1].trim(),e=i[2]}e="{{"+e+"}}",r||s?(l={exp:(0,_exp.default)(e)},r&&(l.key=r),s&&(l.value=s)):l=(0,_exp.default)(e),t.result.repeat=l}else n.push({line:a.line||1,column:a.col||1,reason:"WARNING: for 属性为空"})}function checkEvent(name,value,output){var eventName=name.replace(/^(on|@)/,"");if(eventName&&value){value=_exp.default.removeExprffix(value);var paramsMatch=value.match(/(.*)\((.*)\)/);if(paramsMatch){var funcName=paramsMatch[1],params=paramsMatch[2];params?(params=params.split(/\s*,\s*/),-1===params.indexOf("evt")&&(params[params.length]="evt")):params=["evt"],value="{{"+funcName+"("+params.join(",")+")}}",value=eval("(function (evt) {"+(0,_exp.default)(value,!1).replace("this.evt","evt")+"})")}output.result.events=output.result.events||{},output.result.events[eventName]=value}}function checkAttr(e,t,a,n,r,s){if(e&&(0,_utils.isValidValue)(t)){if(shouldConvertPath(e,t,n))(0,_utils.fileExists)(t,s.filePath)||a.log.push({line:r.line,column:r.column,reason:"WARNING: "+n+" 属性 "+e+" 的值 "+t+" 下不存在对应的文件资源"}),t=(0,_utils.resolvePath)(t,s.filePath);a.result.attr=a.result.attr||{},a.result.attr[(0,_utils.hyphenedToCamelCase)(e)]=(0,_exp.default)(t),"value"===e&&"text"===n&&a.log.push({line:r.line,column:r.column,reason:"WARNING: `value` 应该写在<text>标签中"})}}function shouldConvertPath(e,t,a){return!(!("src"===e&&t&&-1<["img","video"].indexOf(a))||/^(data:|http|{{)/.test(t))}function isReservedTag(e){return-1<tagReserved.indexOf(e)}function isTextContentAomtic(e){return-1<tagTextCotent.indexOf(e)&&-1<tagAtomics.indexOf(e)}function isSupportSpan(e){if(e&&"string"==typeof e)return tagChildrenMap[e]&&-1<tagChildrenMap[e].indexOf("span")}function getTagChildren(e){if(e&&"string"==typeof e)return tagChildrenMap[e]||[]}function isSupportedSelfClosing(e){if(e&&"string"==typeof e)return e=tagAliasMap[e]||e,tagNatives[e]&&!!tagNatives[e].selfClosing}function isEmptyElement(e){return e=tagAliasMap[e]||e,tagNatives[e]&&!0===tagNatives[e].empty}function buildConditionExp(e){return e.map(function(e){return"!(".concat(e,")")}).join(" && ")}Object.keys(tagNatives).forEach(function(t){tagReserved.push(t);var e=tagNatives[t];e.atomic&&tagAtomics.push(t),e.textContent&&tagTextCotent.push(t),e.alias&&e.alias.length&&e.alias.forEach(function(e){tagAliasMap[e]=t}),!0===e.excludeRoot&&tagNotRoot.push(t);var a=(0,_utils.extend)({},e.attrs),n={},r={},s=[];e.attrs&&!1===e.attrs.extendCommon||(a=(0,_utils.extend)(a,tagCommon.attrs)),"extendCommon"in a&&delete a.extendCommon,Object.keys(a).forEach(function(e){var t=a[e];t.enum&&0<t.enum.length&&(n[e]=t.enum,r[e]=t.enum[0]),t.def&&(r[e]=t.def),!0===t.required&&s.push(e)}),tagAttrMap[t]=a,tagEnumAttrMap[t]=n,tagDefaultAttrMap[t]=r,tagRequireAttrMap[t]=s,tagChildrenMap[t]=e.children?(0,_utils.merge)([],tagCommon.children,e.children):null,tagParentsMap[t]=e.parents?(0,_utils.merge)([],tagCommon.parents,e.parents):null,tagEventsMap[t]=(0,_utils.merge)([],tagCommon.events,e.events)});var _default={checkTagName:checkTagName,checkId:checkId,checkClass:checkClass,checkStyle:checkStyle,checkIf:checkIf,checkElse:checkElse,checkElif:checkElif,checkFor:checkFor,checkEvent:checkEvent,checkAttr:checkAttr,checkBuild:checkBuild,isReservedTag:isReservedTag,isTextContentAomtic:isTextContentAomtic,isSupportSpan:isSupportSpan,getTagChildren:getTagChildren,isSupportedSelfClosing:isSupportedSelfClosing,isEmptyElement:isEmptyElement};exports.default=_default;
"use strict";var fs=require("fs"),path=require("path"),info=require("./common/info"),_require=require("./common/config"),initOptions=_require.initOptions,compileOptions=_require.options,HandlerPlugin=require("./webpack/plugin/handler-plugin"),ResourcePlugin=require("./webpack/plugin/resource-plugin"),ZipPlugin=require("./webpack/plugin/zip-plugin"),NotifyPlugin=require("./webpack/plugin/notify-plugin"),_require2=require("./common/utils"),colorconsole=_require2.colorconsole,FILE_EXT_LIST=info.name.extList;function genPriorities(e){var r,n=["manifest.json","app.js",/^common\//i];try{var i=fs.readFileSync(e).toString();r=JSON.parse(i)}catch(e){colorconsole.error("读取 manifest.json 失败： ".concat(e.message))}if(r&&r.router&&r.router.entry){var o=r.router.entry;n.splice(2,0,new RegExp("^".concat(o,"/$")),new RegExp("^".concat(o,"/.+")))}else colorconsole.error("manifest.json 中未配置入口页面 router.entry");return n}function postHook(e,r,n){var i=r.appPackageName,o=r.versionCode,s=r.pathDist,t=r.pathBuild,u=r.pathSrc;initOptions(n);var a=genPriorities(path.join(u,"manifest.json"));e.module.rules.push({test:new RegExp("(".concat(FILE_EXT_LIST.map(function(e){return"\\"+e}).join("|"),")(\\?[^?]+)?$")),use:[path.resolve(__dirname,"webpack/loader","ux-loader.js")]},{test:/\.js$/,use:[path.resolve(__dirname,"webpack/loader","module-loader.js"),"babel-loader"]});var p="dev"===process.env.NODE_PHASE&&n.sign,l="dev"!==process.env.NODE_PHASE&&!n.debug,c=p||l,g=c?"release":"debug";if(e.plugins.push(new HandlerPlugin,new ResourcePlugin({pathSrc:u,pathBuild:t,sign:c}),new ZipPlugin({name:i,versionCode:o,output:s,pathBuild:t,sign:g,priorities:a}),new NotifyPlugin),compileOptions.stats){var d=require("webpack-bundle-analyzer").BundleAnalyzerPlugin;e.plugins.push(new d({analyzerMode:"static",openAnalyzer:!1}))}}module.exports={postHook:postHook};
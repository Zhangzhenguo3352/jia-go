"use strict";var _fs=_interopRequireDefault(require("fs")),_loaderUtils=_interopRequireDefault(require("loader-utils")),_compiler=require("../../compiler"),_info=require("../../common/info"),_utils=require("../../common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var n=[],o=!0,s=!1,r=void 0;try{for(var i,a=e[Symbol.iterator]();!(o=(i=a.next()).done)&&(n.push(i.value),!t||n.length!==t);o=!0);}catch(e){s=!0,r=e}finally{try{o||null==a.return||a.return()}finally{if(s)throw r}}return n}function _arrayWithHoles(e){if(Array.isArray(e))return e}module.exports=function(l,c){var u=this;this.cacheable&&this.cacheable();var s=this.async(),e=_loaderUtils.default.parseQuery(this.query),t=_loaderUtils.default.parseQuery(this.resourceQuery)||{},_=e.type,T=t.uxType,f=this.resourcePath,p=e.index;null!=p&&p.match(/^\d+$/)&&(p=parseInt(p)),Promise.resolve((0,_compiler.parseFragmentsWithCache)(l,f)[_]).then(function(e){null!=p&&(e=e[p]);var t,n=e.content.trim();if(_===_utils.FRAG_TYPE.SCRIPT&&(0,_utils.isUXEntry)(T)&&"Y"===process.env.NODE_TEST)if(f.match(/src\/app\./))n="import '../node_modules/".concat(_info.moduleName,"/tools/packager/common/app.js'\n ").concat(n);else{var o=f.replace("/src/","/test/").replace(/\.\w{2,5}$/,".js");if(_fs.default.existsSync(o)){var s=o.match(/\/test\/(.*)/)[1];n=(n="\nimport fnTestCase from '".concat(s,"'\n").concat(n)).replace("export default {","export default {\n    onCreate () {\n      // 允许back被外部覆盖\n      if (this._options._descriptor) {\n        this._options._descriptor['back'] = {access: 'public'}\n      }\n\n      // 测试执行：开始时间，结束事件\n      global.CASE_TEST_START = global.CASE_TEST_START || 1000\n      global.CASE_TEST_TIMEOUT = global.CASE_TEST_TIMEOUT || 2000\n\n      global.mocha = new Mocha({ reporter: 'json', timeout: global.CASE_TEST_TIMEOUT })\n      mocha.ui('bdd')\n      mocha.suite.emit('pre-require', global, null, mocha);\n      setTimeout(function() {\n        // 记录测试用例\n        typeof fnTestCase === 'function' && fnTestCase(this)\n        var mochaRunner = mocha.run(function () {\n          if (mochaRunner) {\n            // 标题\n            mochaRunner.testResults.stats.title = mocha.suite.suites && mocha.suite.suites[0] && mocha.suite.suites[0].title\n            console.info('testResults: ', JSON.stringify(mochaRunner.testResults))\n            pushData('pageTestList', mochaRunner.testResults)\n\n            // 显示结果\n            const stats = mochaRunner.testResults.stats\n            this.$page.setTitleBar({ text: `通过/全部: ${stats.passes}/${stats.tests}` })\n          }\n\n          // 是否返回\n          if (this.back !== 'false') {\n            console.info('拥有关联测试用例，测试完毕，返回到之前的页面')\n            history.back()\n          }\n        }.bind(this))\n      }.bind(this), global.CASE_TEST_START)\n    },"),_utils.colorconsole.info("[INFO] 脚本注入测试用例：".concat(s))}else n=n.replace("export default {","export default {\n    onCreate () {\n      // 允许back被外部覆盖\n      if (this._options._descriptor) {\n        this._options._descriptor['back'] = {access: 'public'}\n      }\n\n      // 测试执行：开始时间，结束事件\n      global.CASE_TEST_START = global.CASE_TEST_START || 1000\n      global.CASE_TEST_TIMEOUT = global.CASE_TEST_TIMEOUT || 2000\n\n      setTimeout(function() {\n        // 是否返回\n        if (this.back !== 'false') {\n          console.info('没有关联测试用例，直接返回到之前的页面')\n          history.back()\n        }\n      }.bind(this), global.CASE_TEST_START)\n    },")}if(u.sourceMap&&(_===_utils.FRAG_TYPE.SCRIPT||_===_utils.FRAG_TYPE.IMPORT)){var r,i=e.location.line;c&&(r=(0,_utils.consumeMap)(u,l,c),l=r.sourcesContent.join(""));var a=(0,_utils.splitSourceLine)(n).map(function(e,t){var n=(t+=1)+i,o=t;return r&&(n=r.mapping["line-".concat(n,"-column-0")].line),{original:{line:n,column:0},generated:{line:o,column:0}}});t=(0,_utils.generateMap)(u,l,a)}return[n,t]}).then(function(e){var t=_slicedToArray(e,2),n=t[0],o=t[1];s(null,n,o&&o.toJSON()||c)}).catch(function(e){s(e,"")})};
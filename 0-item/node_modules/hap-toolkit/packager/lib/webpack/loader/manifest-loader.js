"use strict";var _path=_interopRequireDefault(require("path")),_loaderUtils=_interopRequireDefault(require("loader-utils")),_utils=require("../../common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var REGEXP_INT=/^[-+]?[0-9]+$/,REGEXP_URL=/^['"]?([^()]+?)['"]?$/gi,REGEXP_NAME=/^[a-zA-Z_][a-zA-Z0-9]*$/,validator={integer:function(e){return(e=(e||"").toString()).match(REGEXP_INT)?{value:!0}:{value:!1,reason:function(e,t){return"ERROR: manifest.json的配置项 `"+e+"` 的值 `"+t+"` 无效(仅支持整数)"}}},object:function(e){var t=(0,_utils.isPlainObject)(e);return{value:(0,_utils.isPlainObject)(e),reason:t?null:function(e,t){return"ERROR: manifest.json的配置项 `"+e+"` 的值 `"+t+"` 无效(仅支持对象)"}}},url:function(e){var t=(e=(e||"").toString().trim()).match(REGEXP_URL);return t?{value:!0}:{value:!1,reason:function(e,t){return"ERROR: manifest.json的配置项 `"+e+"` 的值 `"+t+"` 必须是url"}}},name:function(e){return(e=(e||"").toString()).match(REGEXP_NAME)?{value:!0}:{value:!1,reason:function(e,t){return"ERROR: manifest.json的配置项 `"+e+"` 的值 `"+t+"` 格式不正确"}}}},validatorMap={package:{type:validator.string,require:!0},name:{type:validator.string,require:!0},versionCode:{type:validator.integer,require:!0},icon:{type:validator.url,require:!0},config:{type:validator.object,require:!0},router:{type:validator.object,require:!0}};function validate(e,t){var r,a,n=validatorMap[e];return n&&"function"==typeof n.type?(r=n.type(t)).reason&&(a={reason:r.reason(e,t)}):r={value:!0},{value:r.value,log:a}}var requireAttrMap=[];Object.keys(validatorMap).forEach(function(e){validatorMap[e].require&&requireAttrMap.push(e)}),module.exports=function(e){this.cacheable&&this.cacheable();var t,r,a=_loaderUtils.default.parseQuery(this.query).path,n=_path.default.join(_path.default.dirname(a),"manifest.json"),i=this.fs.readFileSync(n),u=JSON.parse(i),o=[];u&&(requireAttrMap.forEach(function(e){u[e]||o.push({line:1,column:1,reason:"ERROR: manifest.json缺少配置项 `"+e+"`"})}),Object.keys(u).forEach(function(e){t=u[e],(r=validate(e,t)).log&&o.push({line:1,column:1,reason:r.log.reason})}),(0,_utils.logWarn)(this,o),e+="\n(exports.default || module.exports).manifest = ".concat(JSON.stringify(u),";\n"),global.framework.manifest=u);return e};
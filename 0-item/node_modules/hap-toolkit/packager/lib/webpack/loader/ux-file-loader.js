"use strict";var _loaderUtils=_interopRequireDefault(require("loader-utils")),_validator=_interopRequireDefault(require("../../compiler/template/validator")),_uxFragmentUtils=require("./ux-fragment-utils"),_compiler=require("../../compiler"),_utils=require("../../common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var moduleInfo=require("../../../module.json");function loader(e,r){var t=e;t.cacheable&&t.cacheable();var p=_loaderUtils.default.parseQuery(t.resourceQuery),a=t.resourcePath,o=p.uxType,s=p.name||(0,_utils.getNameByPath)(a);_validator.default.isReservedTag(s)&&(0,_utils.logWarn)(t,[{reason:"脚本文件名不能使用保留字:"+s}]),(0,_utils.print)({resourceQuery:t.resourceQuery,resourcePath:t.resourcePath,name:s});var n=(0,_compiler.parseFragmentsWithCache)(r,a);return(0,_utils.print)(n),parseImportList(t,n.import).then(function(){return assemble(t,n,s,o,a)})}function parseImportList(r,e){return Promise.all(e.map(function(e){return resolveImportItemSrc(r,e)}))}function resolveImportItemSrc(e,p){return p.attrs.src?new Promise(function(t){e.resolve(e.context,p.attrs.src,function(e,r){return e?(p.isValid=!1,p.err=e):(p.isValid=!0,p.srcPath=r),t(p)})}):(p.isValid=!1,Promise.resolve(p))}function assemble(e,r,t,p){var a="";if(p===_utils.UX_TYPE.APP)a+=(0,_uxFragmentUtils.processScriptFrag)(e,r.script,p),a+="\n$app_define$('@app-application/".concat(t,"', [], function($app_require$, $app_exports$, $app_module$){\n"),0<r.script.length&&(a+="     $app_script$($app_module$, $app_exports$, $app_require$)\n",a+="     if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default\n        }\n"),a+="})\n",a+="\n$app_bootstrap$('@app-application/".concat(t,"',{ packagerVersion: '").concat(moduleInfo.version,"'})\n");else{var o=[];a+=(0,_uxFragmentUtils.processImportFrag)(e,r.import,o),a+=(0,_uxFragmentUtils.processTemplateFrag)(e,r.template,p,o),a+=(0,_uxFragmentUtils.processStyleFrag)(e,r.style,p),a+=(0,_uxFragmentUtils.processScriptFrag)(e,r.script,p),a+="\n$app_define$('@app-component/".concat(t,"', [], function($app_require$, $app_exports$, $app_module$){\n"),0<r.script.length&&(a+="     $app_script$($app_module$, $app_exports$, $app_require$)\n",a+="     if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default\n        }\n"),a+="     $app_module$.exports.template = $app_template$\n",0<r.style.length&&(a+="     $app_module$.exports.style = $app_style$\n"),a+="})\n",(0,_utils.isUXRender)(p)&&(a+="\n$app_bootstrap$('@app-component/".concat(t,"',{ packagerVersion: '").concat(moduleInfo.version,"'})\n"))}return a}module.exports=loader;
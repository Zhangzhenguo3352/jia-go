"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.processImportFrag=processImportFrag,exports.processTemplateFrag=processTemplateFrag,exports.processStyleFrag=processStyleFrag,exports.processScriptFrag=processScriptFrag;var _path=_interopRequireDefault(require("path")),_validator=_interopRequireDefault(require("../../compiler/template/validator")),_config=require("../../common/config"),_utils=require("../../common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var loaderPath=__dirname,defaultLoaders={component:_path.default.resolve(loaderPath,"ux-loader.js"),fragment:_path.default.resolve(loaderPath,"fragment-loader.js"),template:_path.default.resolve(loaderPath,"template-loader.js"),style:_path.default.resolve(loaderPath,"style-loader.js"),script:_path.default.resolve(loaderPath,"script-loader.js"),module:_path.default.resolve(loaderPath,"module-loader.js"),babel:(0,_utils.loadBabelModule)("babel-loader"),mainfest:_path.default.resolve(loaderPath,"manifest-loader.js"),access:_path.default.resolve(loaderPath,"access-loader.js"),json:_path.default.resolve(loaderPath,"json-loader.js")},optionBabelrc=process&&process.babelrc;function makeLoaderString(e,a,t){var r;return a=a||{},e===_utils.FRAG_TYPE.IMPORT?(r=[{name:defaultLoaders.component,query:{type:_utils.FRAG_TYPE.IMPORT}}],(0,_utils.stringifyLoaders)(r)):e===_utils.FRAG_TYPE.TEMPLATE?(r=[{name:defaultLoaders.json},{name:defaultLoaders.template}],a.alone||r.push({name:defaultLoaders.fragment,query:{index:0,type:_utils.FRAG_TYPE.TEMPLATE}}),(0,_utils.stringifyLoaders)(r)):e===_utils.FRAG_TYPE.STYLE?(r=[{name:defaultLoaders.json},{name:defaultLoaders.style,query:{index:0,type:_utils.FRAG_TYPE.STYLE}}],a.lang&&r.push({name:"".concat(a.lang,"-loader")}),a.alone||r.push({name:defaultLoaders.fragment,query:{index:0,type:_utils.FRAG_TYPE.STYLE}}),(0,_utils.stringifyLoaders)(r)):e===_utils.FRAG_TYPE.SCRIPT?(r=[{name:defaultLoaders.script},{name:defaultLoaders.module}],t===_utils.UX_TYPE.APP?r.push({name:defaultLoaders.mainfest,query:{path:a.path}},{name:defaultLoaders.babel,query:{comments:!1,babelrc:optionBabelrc}}):(r.push({name:defaultLoaders.babel,query:{plugins:[_path.default.resolve(loaderPath,"jsx-loader.js")],comments:!1,babelrc:optionBabelrc}}),(0,_utils.isUXRender)(t)&&r.push({name:defaultLoaders.access})),a.alone||r.push({name:defaultLoaders.fragment,query:{index:0,type:_utils.FRAG_TYPE.SCRIPT}}),(0,_utils.stringifyLoaders)(r)):void 0}function processImportFrag(e,a,t){var r="";if(a.length)for(var s=0;s<a.length;s++){var o=a[s],l=o.attrs.src,n=o.attrs.name;if(!l)return(0,_utils.logWarn)(e,[{reason:"导入组件需要设置属性 `src` "}]),"";if(!o.isValid)return e.emitError("导入组件resolve 出错 ".concat(o.err)),"";l=o.srcPath,n||(n=(0,_utils.getNameByPath)(l)),n=n.toLowerCase(),_validator.default.isReservedTag(n)&&(0,_utils.logWarn)(e,[{reason:"导入组件的属性 `name` 不能使用保留字: "+n}]),t.push(n),(0,_utils.print)({name:n,src:l});var u=(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.IMPORT),"".concat(l,"?uxType=").concat(_utils.UX_TYPE.COMP,"&name=").concat(n));_config.options.stats&&(u="console.time(`PERF: require @app-component/".concat(n,"`)\n").concat(u),u+="console.timeEnd(`PERF: require @app-component/".concat(n,"`)\n\n")),r+=u}return r}function processTemplateFrag(e,a,t,r){var s="";if(a.length){var o=a[0],l=e.resourcePath,n=o.attrs.src;n&&(l=n),r=r.map(function(e){return"importNames[]="+e}),s="var $app_template$ = "+(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.TEMPLATE,{alone:!!n}),"".concat(l,"?uxType=").concat(t,"&").concat(r.join(",")))}else(0,_utils.logWarn)(e,[{reason:"需要模板片段"}]);return s}function processStyleFrag(e,a,t){var r="";if(a.length){var s=a[0],o=e.resourcePath,l=s.attrs.src,n=s.attrs.lang;l&&(o=l),(0,_utils.print)({style:o}),r="var $app_style$ = "+(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.STYLE,{alone:!!l,lang:n}),"".concat(o,"?uxType=").concat(t))}return r}function processScriptFrag(e,a,t){var r="";if(a.length){var s=a[0],o=e.resourcePath,l=s.attrs.src;l&&(o=l),r="var $app_script$ = "+(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.SCRIPT,{alone:!!l,path:e.resourcePath},t),"".concat(o,"?uxType=").concat(t))}return r}
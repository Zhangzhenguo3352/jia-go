"use strict";var _path=_interopRequireDefault(require("path")),_aaptjs=_interopRequireDefault(require("aaptjs")),info=_interopRequireWildcard(require("../../common/info")),_shared=require("../../common/shared"),_utils=require("../../common/utils");function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)if(Object.prototype.hasOwnProperty.call(e,o)){var r=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,o):{};r.get||r.set?Object.defineProperty(t,o,r):t[o]=e[o]}return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var FILE_EXT_LIST=info.name.extList,FILE_EXT_NORES=FILE_EXT_LIST.concat([".js",".jsx",".coffee",".ts",".tsx",".vue",".css",".less",".sass",".styl",".html",".json",".md"]),FILE_NAME_NORES=[".DS_Store","Thumbs.db"];function ResourcePlugin(e){this.options=e}ResourcePlugin.prototype.apply=function(e){var p=this.options,o=e.options;e.hooks.watchRun.tapAsync("ResourcePlugin",function(e,t){Object.keys(o.entry).forEach(function(e){var t=o.entry[e];t instanceof Array&&!/app\.js/.test(e)&&-1!==t[0].indexOf("webpack-dev-server")&&t.shift()}),t()}),e.hooks.emit.tapAsync("ResourcePlugin",function(e,t){var o=p.pathSrc,r=p.pathBuild,n=e.compiler.inputFileSystem,i=e.compiler.outputFileSystem,s=(0,_utils.collectResFile)(n,o,r,FILE_EXT_NORES,FILE_NAME_NORES),a=Object.keys(s).length;function c(){0<--a||(_utils.colorconsole.log("### App Loader ### build目录构建完成"),t())}Object.keys(s).forEach(function(o){var r=s[o];i.mkdirp(_path.default.dirname(o),function(){var e=n.statSync(r);if(e&&e.isFile()){var t=_path.default.basename(r);/.+\.9\.png$/.test(t)?_aaptjs.default.singleCrunch(r,o,function(e){e&&_utils.colorconsole.log("### App Loader ### 转换资源文件(".concat(r,")失败：").concat(e.message)),c()}):n.readFile(r,function(e,t){e&&_utils.colorconsole.log("### App Loader ### 复制资源文件(".concat(r,")失败：").concat(e.message)),i.writeFile(o,t,function(e){e&&_utils.colorconsole.log("### App Loader ### 复制资源文件(".concat(o,")失败：").concat(e.message)),c()})})}})})}),e.hooks.emit.tapAsync("ResourcePlugin",function(e,t){var o=p.pathSrc,r=p.pathBuild,n=e.compiler.inputFileSystem,i=e.compiler.outputFileSystem,s="manifest.json",a=_path.default.join(o,s),c=_path.default.join(r,s);if(-1!==n.readdirSync(o).indexOf(s)){var u=n.readFileSync(a,"utf8"),l=(0,_shared.updateManifestCont)(u,p).manifestCont;p.sign&&(l=JSON.stringify(JSON.parse(l))),i.writeFile(c,l,"utf8",function(e){e&&_utils.colorconsole.error("### App Loader ### 更新资源文件(".concat(c,")失败：").concat(e.message)),t()})}else _utils.colorconsole.error("### App Loader ### ".concat(o,"目录下无资源文件manifest.json")),t()})},module.exports=ResourcePlugin;
"use strict";var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_jszip=_interopRequireDefault(require("jszip")),_dayjs=_interopRequireDefault(require("dayjs")),_sign=require("../../common/sign"),_utils=require("../../common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var COMPRESS_OPTS={type:"nodebuffer",compression:"DEFLATE",compressionOptions:{level:9}},DIGEST_FILE="META-INF/CERT";function ZipPlugin(e){this.options=Object.assign({priorities:["manifest.json","app.js"]},e)}var projectRoot=process.cwd(),SignFileConfig={debug:{privatekey:_path.default.join(projectRoot,"sign/debug/private.pem"),certificate:_path.default.join(projectRoot,"sign/debug/certificate.pem")},release:{privatekey:_path.default.join(projectRoot,"sign/release/private.pem"),certificate:_path.default.join(projectRoot,"sign/release/certificate.pem")}};function resolveFiles(e,i){var t=(0,_utils.lsdirdeep)(e);return t.includes(DIGEST_FILE)?(console.warning("检测到存在快应用保留文件: ".concat(DIGEST_FILE)),!1):t=(0,_utils.sortFilesBy)(t,i)}function zipDigests(e){var i=new _jszip.default;return i.file("hash.json",JSON.stringify({algorithm:"SHA-256",digests:e})),i.generateAsync(COMPRESS_OPTS)}function pack(e){var i=e.files,t=e.digestBuf,r=e.hashList,n=e.base,s=e.privatekey,o=e.certificate,a=new _jszip.default,f={name:Buffer.from("hash.json"),hash:(0,_sign.getBufferDigest)(t)},u=(0,_sign.signZip)({buffer:t,files:[f]},s,o);return a.file(DIGEST_FILE,u),r.unshift({name:Buffer.from(DIGEST_FILE),hash:(0,_sign.getBufferDigest)(u)}),i.forEach(function(e){var i=_path.default.join(n,e);a.file(e,_fs.default.readFileSync(i))}),a.generateAsync(COMPRESS_OPTS)}ZipPlugin.prototype.apply=function(c){var p=this.options,t=SignFileConfig[p.sign];c.hooks.afterEmit.tapAsync("ZipPlugin",function(e,a){if(!t)return _utils.colorconsole.log("### App Loader ### 无签名配置项, 放弃打包: "+p.sign),void a();var f=t.privatekey,u=t.certificate;if(!_fs.default.existsSync(f))return _utils.colorconsole.log("### App Loader ### 缺少私钥文件, 打包失败: "+f),void a();if(!_fs.default.existsSync(u))return _utils.colorconsole.log("### App Loader ### 缺少证书文件, 打包失败: "+u),void a();f=_fs.default.readFileSync(f),u=_fs.default.readFileSync(u);var l=[],r=Object.create(null),i=resolveFiles(p.pathBuild,p.priorities);!1!==i&&(i.forEach(function(e){var i=_path.default.join(p.pathBuild,e),t=_fs.default.readFileSync(i);r[e]=(0,_sign.getBufferDigest)(t).toString("hex"),l.push({name:Buffer.from(e),hash:(0,_sign.getBufferDigest)(t)})}),zipDigests(r).then(function(e){return pack({files:i,hashList:l,digestBuf:e,base:p.pathBuild,privatekey:f,certificate:u})}).then(function(o){_fs.default.mkdir(p.output,function(){var e="".concat(p.name,".").concat(p.sign,".rpk"),i=_path.default.join(p.output,e),t=(0,_sign.signZip)({buffer:o,files:l},f,u);if(_fs.default.writeFileSync(i,t),!c.options.watch){var r=(0,_dayjs.default)().format("YYYYMMDDhhmmss"),n="".concat(p.name,"_").concat(p.sign,"_").concat(p.versionCode,"_").concat(r,".rpk"),s=_path.default.join(p.output,n);_fs.default.writeFileSync(s,t),_utils.colorconsole.log("### App Loader ### 复制 rpk 文件(".concat(e,")为文件(").concat(n,")"))}a()})}))})},module.exports=ZipPlugin;